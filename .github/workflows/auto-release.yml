name: deploy release and notes / change logs

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: validate tag ref
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF:-}" != refs/tags/* ]]; then
            echo "This workflow must be triggered by a tag ref (refs/tags/v*)."
            exit 1
          fi

      # DO MY BUILD HERE
      # IN CASE OF FAILURE, THE STEP BELOW WILL NOT RUN.

      - name: validate release token
        env:
          release_token: ${{ secrets.RELEASE_TOKEN }}
        run: |
          if [ -z "$release_token" ]; then
            echo "RELEASE_TOKEN secret is not set. Create a classic PAT with repo scope and add it as a GitHub Actions secret named RELEASE_TOKEN."
            exit 1
          fi

      - name: generate release notes
        id: release_notes
        shell: bash
        run: |
          set -euo pipefail

          current_tag="${GITHUB_REF_NAME}"

          previous_tag=$(git describe --tags --abbrev=0 --match 'v*' "${current_tag}^" 2>/dev/null || true)

          if [ -z "$previous_tag" ]; then
            range=""
          else
            range="${previous_tag}..${current_tag}"
          fi

          tmp_body_file="release_body.md"

          cat > "$tmp_body_file" << 'EOF'
          ## Apoie o projeto!

          <p align="center">
          
          ![APOIE O PROJETO!](https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbjY2eWc5Y2F0ZW56MmR4aWE0dDhzZXlidXRmYWZyajl1bWZidXZpcyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/87CKDqErVfMqY/giphy.gif)
          
          <p/>

          Se vocÃª achar o projeto Ãºtil, vocÃª pode me apoiar via pix: pix@yuricunha.com ou via QR Code:

          <p align="center">
          
          ![APOIE O PROJETO!](https://i.imgur.com/jx1MAIO.png)
          
          <p/>

          Essa Ã© uma Ã³tima maneira de me mostrar que vocÃª deseja que eu continue desenvolvendo e trabalhando neste projeto por muitos anos - ou enquanto o jogo for atualizado.

          Cuide-se! ðŸ»
          EOF

          echo "" >> "$tmp_body_file"

          if [ -z "$previous_tag" ]; then
            echo "## Commits" >> "$tmp_body_file"
          else
            echo "## Commits desde ${previous_tag}" >> "$tmp_body_file"
          fi

          if [ -z "$range" ]; then
            log_lines=$(git log --format='%H%x09%s')
          else
            log_lines=$(git log --format='%H%x09%s' "$range")
          fi

          if [ -z "$log_lines" ]; then
            echo "- (nenhum commit encontrado)" >> "$tmp_body_file"
          else
            while IFS=$'\t' read -r sha subject; do
              short_sha=$(echo "$sha" | cut -c1-7)
              url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${sha}"
              echo "- ${subject} ([${short_sha}](${url}))" >> "$tmp_body_file"
            done <<< "$log_lines"
          fi

          echo "body_file=${tmp_body_file}" >> "$GITHUB_OUTPUT"

      - name: create github release
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          current_tag="${GITHUB_REF_NAME}"
          title="Release ${current_tag}"

          shopt -s nullglob
          assets=( *.zip *.7zip *.7z )

          if gh release view "$current_tag" >/dev/null 2>&1; then
            gh release edit "$current_tag" --title "$title" --notes-file "${{ steps.release_notes.outputs.body_file }}"
            if [ ${#assets[@]} -gt 0 ]; then
              gh release upload "$current_tag" "${assets[@]}" --clobber
            fi
          else
            if [ ${#assets[@]} -gt 0 ]; then
              gh release create "$current_tag" "${assets[@]}" --title "$title" --notes-file "${{ steps.release_notes.outputs.body_file }}"
            else
              gh release create "$current_tag" --title "$title" --notes-file "${{ steps.release_notes.outputs.body_file }}"
            fi
          fi
